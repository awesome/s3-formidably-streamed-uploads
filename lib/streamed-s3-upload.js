// Generated by CoffeeScript 1.4.0
(function() {
  var BufferedStream, MultiPartUpload, async, formidable, fs, knox, util;

  async = require('async');

  formidable = require('formidable');

  knox = require('knox');

  MultiPartUpload = require('knox-mpu');

  util = require('util');

  fs = require('fs');

  BufferedStream = require('morestreams').BufferedStream;

  module.exports = function(options) {
    var handleFilePart, handleFileUpload, pushToS3, unlinkTempfile;
    options = options || {};
    options.processFilePart = options.processFilePart || function(filePartStream, done) {
      return done(null, [filePartStream]);
    };
    options.getUploadPath = options.getUploadPath || function(fileSetName) {
      return "" + fileSetName;
    };
    pushToS3 = function(readStream, s3UploadPath, cb) {
      var mpu, mpuOptions;
      console.log("[ streamed-s3-upload ] Pushing to S3 (" + readStream.filename + ")");
      mpuOptions = {
        objectName: "" + s3UploadPath + "/" + readStream.filename,
        stream: readStream,
        processFilePart: options.processFilePart,
        client: options.client,
        headers: options.headers
      };
      if (readStream.size != null) {
        mpuOptions.metaInfo = {
          size: readStream.size
        };
      }
      return mpu = new MultiPartUpload(mpuOptions, cb);
    };
    handleFilePart = function(filePartStream, cb) {
      var s3UploadPath;
      s3UploadPath = options.getUploadPath(filePartStream.filename);
      return options.processFilePart(filePartStream, function(err, readStreams) {
        console.log("**** processFilePart");
        if (!Array.isArray(readStreams)) {
          readStreams = [readStreams];
        }
        return async.map(readStreams, (function(readStream, cb2) {
          return pushToS3(readStream, s3UploadPath, cb2);
        }), cb);
      });
    };
    unlinkTempfile = function(file, form) {
      console.info("[ streamed-s3-upload ] unlinking " + file.path);
      return fs.unlink(file.path, function(err) {
        if (err != null) {
          return form.emit('error', error);
        }
      });
    };
    handleFileUpload = function(req, done) {
      var filesMeta, form;
      filesMeta = [];
      form = new formidable.IncomingForm({
        uploadDir: options.uploadDir
      });
      form.keepExtensions = true;
      form.on('s3-upload-completed', function(s3res) {
        console.info("[ streamed-s3-upload ] finished uploading");
        filesMeta.push(s3res);
        form._flushing--;
        return form._maybeEnd();
      });
      form.on('error', function(err) {
        console.info("[ streamed-s3-upload ] an error occured");
        console.error(err);
        return done(err, null);
      });
      form.on('end', function() {
        return done(null, filesMeta);
      });
      form.onPart = function(part) {
        console.info("[ streamed-s3-upload ] onPart begin");
        try {
          if (!part.filename) {
            return form.handlePart(part);
          } else {
            form._flushing++;
            return handleFilePart(part, function(err, s3res) {
              if (err != null) {
                return form.emit('error', err);
              } else {
                return form.emit('s3-upload-completed', s3res);
              }
            });
          }
        } catch (error) {
          return form.emit('error', error);
        }
      };
      return form.parse(req);
    };
    return {
      handleFileUpload: handleFileUpload
    };
  };

}).call(this);
